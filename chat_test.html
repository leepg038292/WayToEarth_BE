<!DOCTYPE html>
<html>
<head>
    <title>크루 채팅 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .chat-container { max-width: 600px; margin: 0 auto; }
        .messages { height: 400px; border: 1px solid #ccc; padding: 10px; overflow-y: auto; margin-bottom: 10px; }
        .message { margin-bottom: 10px; padding: 8px; background: #f5f5f5; border-radius: 5px; }
        .message.system { background: #e3f2fd; }
        .message.announcement { background: #fff3e0; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-group input, .input-group select { padding: 8px; }
        .input-group input[type="text"] { flex: 1; }
        .btn { padding: 8px 16px; background: #2196F3; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .btn:hover { background: #1976D2; }
        .status { padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .status.connected { background: #c8e6c9; color: #2e7d32; }
        .status.disconnected { background: #ffcdd2; color: #c62828; }
        .config { background: #f5f5f5; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .config h3 { margin-top: 0; }
    </style>
</head>
<body>
    <div class="chat-container">
        <h1>크루 채팅 WebSocket 테스트</h1>

        <div class="config">
            <h3>설정</h3>
            <div class="input-group">
                <input type="text" id="tokenInput" placeholder="JWT 토큰" style="flex: 2;">
                <input type="number" id="crewIdInput" placeholder="크루 ID" value="1" style="width: 100px;">
                <button class="btn" onclick="connect()">연결</button>
                <button class="btn" onclick="disconnect()" style="background: #f44336;">연결 해제</button>
            </div>
        </div>

        <div id="status" class="status disconnected">연결 안됨</div>

        <div id="messages" class="messages"></div>

        <div class="input-group">
            <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." onkeypress="handleKeyPress(event)">
            <select id="messageType">
                <option value="TEXT">일반</option>
                <option value="ANNOUNCEMENT">공지</option>
                <option value="SYSTEM">시스템</option>
            </select>
            <button class="btn" onclick="sendMessage()">전송</button>
        </div>

        <div style="margin-top: 20px;">
            <h3>테스트 정보</h3>
            <p><strong>JWT 토큰 획득:</strong></p>
            <pre>curl -X POST "http://localhost:8080/v1/auth/mock-login" -H "Content-Type: application/json" -d '{"email": "test@example.com", "userId": 1}'</pre>

            <p><strong>WebSocket URL 형식:</strong></p>
            <pre>ws://localhost:8080/ws/crew/{crewId}/chat?token={jwtToken}</pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script>
        let socket = null;

        function connect() {
            const token = document.getElementById('tokenInput').value;
            const crewId = document.getElementById('crewIdInput').value;

            if (!token || !crewId) {
                alert('JWT 토큰과 크루 ID를 모두 입력해주세요.');
                return;
            }

            if (socket) {
                socket.close();
            }

            // SockJS를 사용하여 연결
            const url = `http://localhost:8080/ws/crew/${crewId}/chat?token=${token}`;
            socket = new SockJS(url);

            socket.onopen = function() {
                updateStatus('연결됨', true);
                addMessage('시스템', '웹소켓 연결이 성공했습니다.', 'SYSTEM');
            };

            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addMessage(data.senderName || '알 수 없음', data.message, data.messageType);
                } catch (e) {
                    addMessage('시스템', '메시지 파싱 오류: ' + event.data, 'SYSTEM');
                }
            };

            socket.onclose = function() {
                updateStatus('연결 해제됨', false);
                addMessage('시스템', '웹소켓 연결이 종료되었습니다.', 'SYSTEM');
            };

            socket.onerror = function(error) {
                updateStatus('연결 오류', false);
                addMessage('시스템', '연결 오류: ' + error, 'SYSTEM');
            };
        }

        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
        }

        function sendMessage() {
            if (!socket || socket.readyState !== SockJS.OPEN) {
                alert('먼저 웹소켓에 연결해주세요.');
                return;
            }

            const messageInput = document.getElementById('messageInput');
            const messageType = document.getElementById('messageType').value;
            const message = messageInput.value.trim();

            if (!message) {
                alert('메시지를 입력해주세요.');
                return;
            }

            const chatMessage = {
                message: message,
                messageType: messageType
            };

            socket.send(JSON.stringify(chatMessage));
            messageInput.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function updateStatus(text, connected) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = text;
            statusElement.className = connected ? 'status connected' : 'status disconnected';
        }

        function addMessage(sender, message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            if (type === 'SYSTEM') {
                messageDiv.className += ' system';
            } else if (type === 'ANNOUNCEMENT') {
                messageDiv.className += ' announcement';
            }

            const timestamp = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `<strong>[${timestamp}] ${sender}:</strong> ${message}`;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // 페이지 로드시 토큰 입력란에 예시 토큰 설정
        document.addEventListener('DOMContentLoaded', function() {
            // 최근에 받은 토큰을 여기에 붙여넣으세요
            document.getElementById('tokenInput').value = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwiaWF0IjoxNzU4ODY0MjExLCJleHAiOjE3NTg5NTA2MTF9.9ZVDxCqNNXwURo7lwNQsLFSkb-86U_Pd-FKRwqDvWiQ';
        });
    </script>
</body>
</html>