name: Deploy WayToEarth Backend to EC2 using Docker

on:
  pull_request:
    branches:
      - dev
  push:
    branches:
      - dev

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Set up JDK 21 (Temurin)
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build & Test with Gradle
        run: ./gradlew clean build -x test

  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Set up JDK 21 (Temurin)
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Create Firebase Service Account JSON
        run: |
          mkdir -p src/main/resources/firebase
          echo '${{ secrets.FCM_CONFIG_JSON }}' > src/main/resources/firebase/firebase-service-account.json

      - name: Build with Gradle (Skip Tests)
        run: ./gradlew build -x test

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          IMAGE_NAME=docker.io/${{ secrets.DOCKER_USERNAME }}/waytoearth:latest
          docker build -t $IMAGE_NAME .
          for i in 1 2 3; do
            docker push $IMAGE_NAME && break || (echo "Retrying push ($i/3)..." && sleep 15)
          done

      # DNS Ìï¥ÏÑù ÌôïÏù∏Ïö© ÎîîÎ≤ÑÍπÖ Ïä§ÌÖù
      - name: Debug DNS Resolution
        run: dig +short deploy.waytoearth.cloud

      - name: Deploy on EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}   # deploy.waytoearth.cloud ÎÑ£ÏùÑ Í≤É
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e
            IMAGE_NAME=docker.io/${{ secrets.DOCKER_USERNAME }}/waytoearth:latest

            echo "üõë Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è ÏÇ≠Ï†ú"
            docker stop waytoearth || true
            docker rm waytoearth || true

            echo "üì¶ ÏµúÏã† Ïù¥ÎØ∏ÏßÄ Pull"
            for i in 1 2 3; do
              docker pull "$IMAGE_NAME" && break || (echo "Retrying pull ($i/3)..." && sleep 15)
            done

            echo "üöÄ ÏÉà Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ (ÏûêÎèô Ïû¨ÏãúÏûë ÌôúÏÑ±Ìôî)"
            docker run -d \
              --restart always \
              -p 8080:8080 \
              --name waytoearth \
              -e SPRING_PROFILES_ACTIVE="${{ vars.SPRING_PROFILES_ACTIVE }}" \
              -e AWS_REGION="${{ vars.AWS_REGION }}" \
              -e KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}" \
              -e KAKAO_REDIRECT_URI="${{ secrets.KAKAO_REDIRECT_URI }}" \
              -e KAKAO_TOKEN_URI="${{ vars.KAKAO_TOKEN_URI }}" \
              -e KAKAO_USER_INFO_URI="${{ vars.KAKAO_USER_INFO_URI }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e DB_URL="${{ secrets.DB_URL }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e KAKAO_REDIRECT_URI_MOBILE="${{ secrets.KAKAO_REDIRECT_URI_MOBILE }}" \
              -e KAKAO_REDIRECT_URI_WEB="${{ secrets.KAKAO_REDIRECT_URI_WEB }}" \
              -e S3_BUCKET="${{ vars.S3_BUCKET }}" \
              -e OPENWEATHER_API_KEY="${{ secrets.OPENWEATHER_API_KEY }}" \
              -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              -e JWT_EXPIRATION="${{ vars.JWT_EXPIRATION }}" \
              -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
              -e REDIS_PORT="${{ vars.REDIS_PORT }}" \
              -e FCM_CONFIG_JSON='${{ secrets.FCM_CONFIG_JSON }}' \
              -e FCM_ENABLED="${{ vars.FCM_ENABLED }}" \
              "$IMAGE_NAME"

            echo "üßπ Ïïà Ïì∞Îäî Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨"
            docker image prune -f

            echo "‚è≥ Waiting for app to start (max 60s)..."
            for i in {1..12}; do
              if curl -fsS http://127.0.0.1:8080/actuator/health | grep -q '"status":"UP"'; then
                echo "‚úÖ App is healthy!"
                exit 0
              fi
              echo "‚è≥ Still starting... ($i/12)"
              sleep 5
            done

            echo "‚ùå App failed to start within 60s"
            docker logs --tail 200 waytoearth || true
            exit 1
